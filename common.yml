#######################################
#    Tools Driver Config for MCI      #
#######################################
# default command type
command_type: system

# run the same task in the previous revision if the current task fails
stepback: true

mongo_tools_variables:

## List of tests to run on each buildvariant
  mongo_tools_task_lists:
    mac_task_list: &macos_tasks
      - name: dist
      - name: sign
        run_on: macos-1014-codesign
      - name: push
        run_on: rhel70-small
      - name: integration-3.4
      - name: integration-3.4-mmapv1
      - name: integration-3.6
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: integration-4.0-mmapv1
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      - name: qa-tests-3.2
      - name: qa-tests-3.4
      - name: qa-tests-3.6
      - name: qa-tests-4.0
      - name: qa-tests-4.2
      - name: qa-tests-4.4
      - name: qa-dump-restore-with-gzip-current
      - name: qa-dump-restore-with-archiving-current
      - name: native-cert-ssl-current
      - name: unit
    rhel_x86_64_task_list: &rhel_x86_64_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      - name: integration-3.4
      - name: integration-3.4-mmapv1
      - name: integration-3.6
      - name: integration-3.6-mmapv1
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: integration-4.0-mmapv1
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      # Disabled due to TOOLS-2119
      # - name: kerberos
      - name: legacy42
      - name: qa-tests-3.2
      - name: qa-tests-3.4
      - name: qa-tests-3.6
      - name: qa-tests-4.0
      - name: qa-tests-4.2
      - name: qa-tests-4.4
      - name: qa-dump-restore-with-gzip-current
        run_on: rhel62-large
      - name: qa-dump-restore-with-archiving-current
      - name: native-cert-ssl-current
      - name: unit
    ubuntu_x86_64_task_list: &ubuntu_x86_64_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      - name: integration-3.4
      - name: integration-3.4-mmapv1
      - name: integration-3.6
      - name: integration-3.6-mmapv1
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: integration-4.0-mmapv1
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      - name: kerberos
      - name: qa-tests-3.2
      - name: qa-tests-3.4
      - name: qa-tests-3.6
      - name: qa-tests-4.0
      - name: qa-tests-4.2
      - name: qa-tests-4.4
      - name: qa-dump-restore-with-gzip-current
        run_on: ubuntu1604-build
      - name: qa-dump-restore-with-archiving-current
      - name: native-cert-ssl-current
      - name: unit
    ubuntu_x86_64_race_task_list: &ubuntu_x86_64_race_tasks
      - name: dist
      - name: integration-3.6
      - name: integration-3.6-mmapv1
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: integration-4.0-mmapv1
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      - name: qa-tests-4.0
      - name: qa-tests-4.2
      - name: qa-tests-4.4
      - name: unit
    windows_64_task_list: &windows_64_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      # Disabled: see TOOLS-2662
      # - name: integration-3.6
      # - name: integration-3.6-mmapv1
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: integration-4.0-mmapv1
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
        distros:
        - windows-64-vs2017-test
      - name: kerberos
        distros:
        - windows-64-vs2017-test
      - name: qa-tests-3.2
        distros:
        - windows-64-vs2017-test
      - name: qa-tests-3.4
        distros:
        - windows-64-vs2017-test
      - name: qa-tests-3.6
        distros:
        - windows-64-vs2017-test
      - name: qa-tests-4.0
        distros:
        - windows-64-vs2017-test
      - name: qa-tests-4.2
        distros:
        - windows-64-vs2017-test
      - name: qa-tests-4.4
        distros:
        - windows-64-vs2017-test
      - name: qa-dump-restore-with-archiving-current
        distros:
        - windows-64-vs2017-test
      - name: qa-dump-restore-with-gzip-current
        distros:
        - windows-64-vs2017-test
      - name: unit
      - name: native-cert-ssl-current
    rhel71_ppc64le_task_list: &rhel71_ppc64le_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      - name: integration-3.4
      - name: integration-3.4-mmapv1
      - name: integration-3.6
      - name: integration-3.6-mmapv1
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: integration-4.0-mmapv1
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      #- name: kerberos
      - name: qa-dump-restore-with-archiving-current
      - name: qa-dump-restore-with-gzip-current
      - name: qa-tests-3.4
      - name: qa-tests-3.6
      - name: qa-tests-4.0
      - name: qa-tests-4.2
      - name: qa-tests-4.4
      - name: native-cert-ssl-current
    rhel81_ppc64le_task_list: &rhel81_ppc64le_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
    rhel67_s390x_task_list: &rhel67_s390x_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      - name: integration-3.6
      - name: integration-3.6-mmapv1
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: integration-4.0-mmapv1
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      # Disabled due to TOOLS-2119
      # - name: kerberos
      - name: qa-dump-restore-with-archiving-current
      - name: qa-dump-restore-with-gzip-current
      - name: qa-tests-3.4
      - name: qa-tests-3.6
      - name: qa-tests-4.0
      - name: qa-tests-4.2
      - name: qa-tests-4.4
      - name: native-cert-ssl-current
    ubuntu1604_arm64_task_list: &ubuntu1604_arm64_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      - name: integration-3.4
      - name: integration-3.6
      - name: integration-4.0
      - name: integration-4.0-auth
      - name: integration-4.0-cluster
      - name: qa-tests-3.4
      - name: qa-tests-3.6
      - name: qa-tests-4.0
    ubuntu1804_arm64_task_list: &ubuntu1804_arm64_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      - name: integration-4.2
      - name: integration-4.2-auth
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      - name: qa-dump-restore-with-archiving-current
      - name: qa-dump-restore-with-gzip-current
      - name: qa-tests-4.2
      - name: qa-tests-4.4
      - name: native-cert-ssl-current
    ubuntu2004_arm64_task_list: &ubuntu2004_arm64_tasks
      - name: dist
      - name: sign
        run_on: amazon1-2018-test
      - name: push
        run_on: rhel70-small
      - name: integration-4.4
      - name: integration-4.4-auth
      - name: integration-4.4-cluster
      - name: qa-dump-restore-with-archiving-current
      - name: qa-dump-restore-with-gzip-current
      - name: qa-tests-4.4
      - name: native-cert-ssl-current


## Common mongodb arguments
  mongod_arguments:
    default: &mongod_default_startup_args
      mongod_args: ""
      mongod_port: 33333
    ssl: &mongod_ssl_startup_args
      mongod_args: "--sslMode requireSSL --sslCAFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/ca-ia.pem --sslPEMKeyFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/test-server.pem"
      replsettest_ssl_config: "sslMode: \\\"requireSSL\\\",sslPEMKeyFile: \\\"vendor/github.com/mongodb/mongo-tools-common/db/testdata/test-server.pem\\\", sslCAFile: \\\"vendor/github.com/mongodb/mongo-tools-common/db/testdata/ca-ia.pem\\\", sslAllowInvalidHostnames: \\\"\\\""
      mongod_port: 33333
    tls: &mongod_tls_startup_args
      mongod_args_tls: "--tlsMode requireTLS --tlsCAFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/ca-ia.pem --tlsCertificateKeyFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/test-server.pem"
      replsettest_tls_config: "tlsMode: \\\"requireTLS\\\",tlsCertificateKeyFile: \\\"vendor/github.com/mongodb/mongo-tools-common/db/testdata/test-server.pem\\\", tlsCAFile: \\\"vendor/github.com/mongodb/mongo-tools-common/db/testdata/ca-ia.pem\\\", tlsAllowInvalidHostnames: \\\"\\\""
      mongod_port: 33333

  mongo_arguments:
    default: &mongo_default_startup_args
      mongo_args: &mongo_default_startup_args_string "--port 33333"
      mongod_port: 33333
    ssl: &mongo_ssl_startup_args
      mongo_args: "--port 33333 --ssl --sslCAFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/ca-ia.pem --sslPEMKeyFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/test-server.pem --sslAllowInvalidCertificates"
      mongod_port: 33333
    tls: &mongo_tls_startup_args
      mongo_args_tls: "--port 33333 --tls --tlsCAFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/ca-ia.pem --tlsCertificateKeyFile vendor/github.com/mongodb/mongo-tools-common/db/testdata/test-server.pem --tlsAllowInvalidCertificates"
      mongod_port: 33333

functions:

  "run legacy tests":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        chmod +x bin/*
        mv bin/* ${test_path}/
        cd ${test_path}
        ./mongo --nodb jstests/tool/*.js

  "run qa-tests":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        chmod +x bin/*
        mv bin/* test/qa-tests/
        cd test/qa-tests
        chmod 400 jstests/libs/key*

        python buildscripts/resmoke.py --suite=${resmoke_suite} --continueOnFailure --log=buildlogger --reportFile=../../report.json ${resmoke_args} --excludeWithAnyTags="${excludes}"

  "build tool":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        echo "Building ${tool}..."
        if [ "Windows_NT" = "$OS" ]; then
            set -o igncr
        fi;
        # In RHEL 5.5, /usr/bin/ld can't handle --build-id parameters, so
        # use a wrapper if it's present on the system
        #
        if [ -d /opt/ldwrapper/bin ]
        then
          export PATH=/opt/ldwrapper/bin:$PATH
        fi

        . ./set_goenv.sh
        GOROOT=""; set_goenv || exit
        go version
        env | grep ^GO
        go build $(buildflags) -ldflags "$(print_ldflags)" ${args} -tags "$(print_tags failpoints ${build_tags})" -o bin/${tool} ${tool}/main/${tool}.go
        ./bin/${tool} --version

  "download mongod":
    command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        mongotarget=$(if [ "${mongo_target}" ]; then echo "${mongo_target}"; else echo "${mongo_os}"; fi)
        mongoversion=$(if [ "${mongo_version_always_use_latest}" ]; then echo "latest"; else echo "${mongo_version}"; fi)
        dlurl=$(python binaryurl.py --edition=${mongo_edition} --target=$mongotarget --version=$mongoversion --arch=${mongo_arch|x86_64})
        filename=$(echo $dlurl | sed -e "s_.*/__")
        mkdir -p bin
        curl -s $dlurl --output $filename
        ${decompress} $filename
        rm $filename
        if [ "${only_shell}" ]; then
          mv -f ./mongodb-*/bin/mongo${extension} ./bin/
        else
          mv -f ./mongodb-*/bin/mongo${extension} ./bin/
          mv -f ./mongodb-*/bin/mongos${extension} ./bin/
          mv -f ./mongodb-*/bin/mongod${extension} ./bin/
        fi
        chmod +x ./bin/*
        rm -rf ./mongodb-*

  "fetch tool" :
    command: s3.get
    params:
      bucket: mciuploads
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      local_file: src/github.com/mongodb/mongo-tools/bin/${tool}${extension}
      remote_file: mongo-tools/binaries/${build_id}/${edition|community}/${tool}${extension}

  "generate coverage html + text":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        if [ "${coverage}" = "true" ]; then
          if [ "Windows_NT" = "$OS" ]; then
            set -o igncr
          fi;
          go tool cover -html=coverage.out -o coverage.html
          go tool cover -func=coverage.out -o coverage.txt
        fi;

  "get buildnumber":
    command: keyval.inc
    params:
      key: "${build_variant}_tools"
      destination: "builder_num"

  "move coverage data":
    command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        if [ "${coverage}" = "true" ]; then
          mv ${package}/coverage.out .
        fi

  "run unit test":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        # export sensitive info before `set -x`
        export MONGODB_KERBEROS_PASSWORD=${kerberos_password}
        set -x
        set -v
        if [ "Windows_NT" = "$OS" ]; then
            set -o igncr
        fi;
        export basedir=$PWD
        . ./set_goenv.sh
        GOROOT=""; set_goenv || exit
        cd ${package}
        go test $(buildflags) -ldflags "$(print_ldflags)" ${coverage_args} -tags "$(print_tags ${build_tags})" -test.v > unit.suite
        export exitcode=$?
        cat unit.suite
        cp unit.suite $basedir/.
        exit $exitcode

  "setup integration test":
    command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      # Set up Kerberos stuff: run kinit if necessary, and add KDC to registry
      # on Windows (see https://wiki.mongodb.com/display/DH/Testing+Kerberos)
      script: |
        set -e
        # export sensitive info before `set -x`
        if [ '${run_kinit}' = 'true' ]; then
            # BUILD-3830
            mkdir -p "$(pwd)/.evergreen"
            touch "$(pwd)/.evergreen/krb5.conf.empty"
            export KRB5_CONFIG="$(pwd)/.evergreen/krb5.conf.empty"

            echo "Writing keytab"
            echo ${kerberos_keytab} | base64 -d > "$(pwd)/.evergreen/drivers.keytab"
            echo "Running kinit"
            kinit -k -t "$(pwd)/.evergreen/drivers.keytab" -p drivers@LDAPTEST.10GEN.CC;
        fi;
        set -x
        set -v
        if [ "Windows_NT" = "$OS" ]; then
          cmd /c "REG ADD HKLM\SYSTEM\ControlSet001\Control\Lsa\Kerberos\Domains\LDAPTEST.10GEN.CC /v KdcNames /d ldaptest.10gen.cc /t REG_MULTI_SZ /f"
        fi;

  "run tool unit tests":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        if [ "Windows_NT" = "$OS" ]; then
            set -o igncr
        fi;

        . ./set_goenv.sh
        GOROOT=""; set_goenv || exit
        if [ "${UNIT_TEST}" = "true" ]; then
          export TOOLS_TESTING_UNIT="true"
        fi;
        if [ "${run_coverage}" = "true" ]; then
            export RUN_COVERAGE="true"
        fi
        export ON_EVERGREEN="true"
        export TOOLS_BUILD_TAGS=${build_tags}
        ./runTests.sh -v
        exit $?

  "run tool integration tests":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        # export sensitive info before `set -x`
        if [ "Windows_NT" = "$OS" ]; then
            set -o igncr
            export MONGODB_KERBEROS_PASSWORD=${kerberos_password}
        fi;
        set -x
        set -v
        . ./set_goenv.sh
        GOROOT=""; set_goenv || exit
        if [ "${KERBEROS_TEST}" = "true" ]; then
          export TOOLS_TESTING_KERBEROS="true"
        elif [ "${USE_SSL}" = "true" ]; then
          export TOOLS_TESTING_SSL="true"
          export TOOLS_TESTING_INTEGRATION="true"
        fi;
        if [ "${AUTH_TEST}" = "true" ]; then
          export TOOLS_TESTING_AUTH="true"
          export TOOLS_TESTING_INTEGRATION="true"
        fi;
        if [ "${INT_TEST}" = "true" ]; then
          export TOOLS_TESTING_INTEGRATION="true"
        fi;
        MONGO_ARGS="${mongo_args}"
        if [ "${USE_TLS}" = "true" ]; then
          MONGO_ARGS="${mongo_args_tls}"
          export TOOLS_TESTING_SSL="true"
          export TOOLS_TESTING_INTEGRATION="true"
        fi;
        if [ "${create_mongod_users_command}" != "" ]; then
          export TOOLS_TESTING_AUTH_USERNAME=${auth_username}
          export TOOLS_TESTING_AUTH_PASSWORD=${auth_password}
          echo "${create_mongod_users_command}" | ./bin/mongo${extension} $MONGO_ARGS admin
        fi;
        export ON_EVERGREEN="true"
        export TOOLS_BUILD_TAGS="${build_tags}"
        ./runTests.sh -v
        exit $?


  "create coverage reports":
    command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        set -o verbose
        if [ "Windows_NT" = "$OS" ]; then
            set -o igncr
        fi;

        . ./set_goenv.sh
        GOROOT=""; set_goenv || exit

        # XXX Need to fix up use of 'src' below somehow; for now commented out
        # because we're using an actual GOPATH instead of a hack and replaced with a copy
        for i in mongoimport mongoexport mongostat mongorestore mongodump mongofiles; do
            cd $i
            # perl -pe 's/.*src/github.com\/mongodb\/mongo-tools/' coverage_$i.out > coverage_$i_rewrite.out
            go tool cover -html=coverage_$i.out -o coverage_$i.html
            go tool cover -func=coverage_$i.out -o coverage_$i.txt
            cd ..
        done

  "upload html coverage":
    command: s3.put
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      local_file: src/github.com/mongodb/mongo-tools/${coverage_pkg}/coverage_${coverage_pkg}.html
      remote_file: mongo-tools/coverage/${coverage_pkg}/${task_id}.html
      bucket: mciuploads
      permissions: public-read
      content_type: text/html
      build_variants: ["ubuntu", "windows-64"]
      display_name: ${coverage_pkg}-html

  "upload text coverage":
    command: s3.put
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      local_file: src/github.com/mongodb/mongo-tools/${coverage_pkg}/coverage_${coverage_pkg}.txt
      remote_file: mongo-tools/coverage/${coverage_pkg}/${task_id}.txt
      bucket: mciuploads
      permissions: public-read
      content_type: text/plain
      build_variants: ["ubuntu", "windows-64"]
      display_name: ${coverage_pkg}-text

  "setup credentials" :
    command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      silent: true
      script: |
        set -x
        set -v
        set -e
        cat > mci.buildlogger <<END_OF_CREDS
        slavename='${slave}'
        passwd='${passwd}'
        builder='MCI_${build_variant}'
        build_num=${builder_num}
        build_phase='${task_name}_${execution}'
        END_OF_CREDS
        # Resmoke hardcodes the location of this file so we need to copy it to the working directory
        # we run resmoke from.
        cp mci.buildlogger test/qa-tests

  "start mongod":
    command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      background: true
      script: |
        set -x
        set -v
        set -e
        rm -rf mongodb/db_files mongodb/${logfile|run.log}
        mkdir -p mongodb/db_files
        MONGOD_ARGS="${mongod_args}"
        if [ "${USE_TLS}" = "true" ]; then
          MONGOD_ARGS="${mongod_args_tls}"
        fi;
        echo "Starting mongod..."
        storage_args=''
        if [ "${STORAGE_ENGINE}" != '' ]; then
          storage_args='--storageEngine ${STORAGE_ENGINE}'
        fi
        PATH=$PWD/bin:$PATH ./bin/mongod${extension}  --port ${mongod_port} $MONGOD_ARGS ${additional_args} --dbpath mongodb/db_files --setParameter=enableTestCommands=1 $storage_args

  "start mongod cluster":
    command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      background: true
      script: |
        set -x
        set -v
        set -e
        rm -rf mongodb/db_files mongodb/${logfile|run.log}
        mkdir -p mongodb/db_files
        MONGOD_ARGS="${mongod_args}"
        if [ "${USE_TLS}" = "true" ]; then
          MONGOD_ARGS="${mongod_args_tls}"
        fi;
        echo "Starting mongod cluster..."
        PATH=$PWD/bin:$PATH ./bin/mongod${extension}  --port ${mongod_port} $MONGOD_ARGS ${additional_args} --dbpath mongodb/db_files --setParameter=enableTestCommands=1 --replSet repltester

  "wait for mongod to be ready":
    command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        SECS=0
        MONGO_ARGS="${mongo_args}"
        if [ "${USE_TLS}" = "true" ]; then
          MONGO_ARGS="${mongo_args_tls}"
        fi;
        while true ; do
            set -o verbose

            ./bin/mongo${extension} $MONGO_ARGS --eval 'true;'
            if [ "$?" = "0" ]; then
                echo "mongod ready";
                exit 0
            else
                SECS=`expr $SECS + 1`
                if [ $SECS -gt 20 ]; then
                    echo "mongod not ready after 20 seconds"
                    exit 1
                fi
                echo "waiting for mongod $MONGO_ARGS to be ready..."  ;
                sleep 1 ;
            fi
        done

  "upload tool":
    command: s3.put
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      local_file: src/github.com/mongodb/mongo-tools/bin/${tool}
      remote_file: mongo-tools/binaries/${build_id}/${edition|community}/${tool}${extension}
      bucket: mciuploads
      permissions: public-read
      content_type: application/octet-stream
      display_name: ${tool}

  "create release artifacts":
    # build release artifacts
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          ${_set_shell_env}
          go run release/release.go build-archive
          go run release/release.go build-packages

    # temporary workaround for TOOLS-2606
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          rm -rf ./mongorestore/testdata/longcollectionname/

    # upload individual release artifacts to task page
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_files_include_filter:
          - src/github.com/mongodb/mongo-tools/release.*
          - src/github.com/mongodb/mongo-tools/*.deb
          - src/github.com/mongodb/mongo-tools/*.rpm
        remote_file: mongo-tools/pkgs/${build_id}/
        content_type: application/octet-stream
        bucket: mciuploads
        permissions: public-read
        display_name: "Release Artifact - "

    # pack all release artifacts into a tarball and upload them to one
    # place so that they can be more easily downloaded by the sign task
    - command: archive.targz_pack
      params:
        target: src/github.com/mongodb/mongo-tools/upload.tgz
        source_dir: src/github.com/mongodb/mongo-tools
        include:
          - "./release.*"
          - "*.deb"
          - "*.rpm"
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/github.com/mongodb/mongo-tools/upload.tgz
        remote_file: mongo-tools/task/dist/${build_id}/all-release-artifacts.tgz
        content_type: application/x-gzip
        bucket: mciuploads
        permissions: public-read
        display_name: All Release Artifacts (.tgz)

  "fetch dist release artifacts":
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongo-tools/task/dist/${build_id}/all-release-artifacts.tgz
        extract_to: src/github.com/mongodb/mongo-tools/
        bucket: mciuploads

  "sign msi installer":
    - command: shell.exec
      type: system
      params:
        working_dir: src/github.com/mongodb/mongo-tools/
        silent: true
        script: |
          echo "${signing_auth_token}" > ./signing_auth_token
    - command: shell.exec
      # If the notary service is failing, it should be a system failure to alert the evg team.
      # We overwrite the existing release.msi with a signed version via --package-file-suffix ""
      type: system
      params:
        working_dir: src/github.com/mongodb/mongo-tools/
        script: |
          if [ "${mongo_os}" = "osx" ]; then
              exit 0
          fi
          /usr/local/bin/notary-client.py \
              --key-name "server-Tools" \
              --auth-token-file ./signing_auth_token \
              --comment "Evergreen Automatic Signing (mongo-tools)" \
              --notary-url http://notary-service.build.10gen.cc:5000 \
              --skip-missing \
              --outputs "sig" \
              --package-file-suffix "" \
              release.msi

  "sign macos zip":
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools/
        silent: false
        script: |
          set -o xtrace
          set -o errexit
          set -o verbose
          if [ "${mongo_os}" != "osx" ]; then
              exit 0
          fi
          curl -sL https://github.com/mitchellh/gon/releases/download/v0.2.3/gon_macos.zip > gon.zip
          unzip gon.zip
          OUTPUT_PATH="./release.zip"
          AC_USERNAME="${ac_username}"
          AC_PASSWORD="${ac_password}"
          # gon settings
          cat <<EOF_GON_JSON > gon.json
          {
            "source" : ["LICENSE.md", "README.md", "THIRD-PARTY-NOTICES",
              "bin/bsondump", "bin/mongodump",  "bin/mongoexport",
              "bin/mongofiles", "bin/mongoimport",  "bin/mongorestore",
              "bin/mongostat",  "bin/mongotop"
            ],
            "bundle_id" : "com.mongodb.mongotools",
            "apple_id": {
              "username": "$AC_USERNAME",
              "password": "$AC_PASSWORD"
            },
            "sign" :{
              "application_identity" : "Developer ID Application: MongoDB, Inc. (4XWMY46275)"
            },
            "zip" :{
              "output_path": "$OUTPUT_PATH"
            }
          }
          EOF_GON_JSON
          tar xvzf release.tgz
          mv mongodb-database-tools*/* ./
          ssh -v -p 2222 localhost -t "cd $PWD && ./gon -log-level=info gon.json"

  "sign linux packages":
    - command: shell.exec
      type: system
      params:
        working_dir: src/github.com/mongodb/mongo-tools/
        silent: true
        script: |
          if [ "${mongo_os}" = "osx" ]; then
              exit 0
          fi
          echo "${signing_auth_token_server_4_4}" > ./signing_auth_token
    - command: shell.exec
      type: system
      params:
        working_dir: src/github.com/mongodb/mongo-tools/
        silent: false
        script: |
          if [ "${mongo_os}" = "osx" ]; then
              exit 0
          fi
          set -o errexit
          if [ -e *.rpm ]; then
             /usr/local/bin/notary-client.py \
                --key-name "server-4.4" \
                --auth-token-file ./signing_auth_token \
                --comment "Evergreen Automatic Signing (mongo-tools)" \
                --notary-url http://notary-service.build.10gen.cc:5000 \
                --skip-missing \
                --package-file-suffix "" \
                --outputs "sig" \
                *.rpm
          fi

  "sign archives":
    - command: shell.exec
      type: system
      params:
        working_dir: src/github.com/mongodb/mongo-tools/
        silent: true
        script: |
          echo "${signing_auth_token}" > ./signing_auth_token
    - command: shell.exec
      type: system
      params:
        working_dir: src/github.com/mongodb/mongo-tools/
        script: |
          if [ "${mongo_os}" = "osx" ]; then
              exit 0
          fi
          /usr/local/bin/notary-client.py \
              --key-name "server-Tools" \
              --auth-token-file ./signing_auth_token \
              --comment "Evergreen Automatic Signing (mongo-tools)" \
              --notary-url http://notary-service.build.10gen.cc:5000 \
              --skip-missing \
              --outputs "sig" \
              *.zip *.tgz

  "upload signed release artifacts":
    # temporary workaround for TOOLS-2606
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          rm -rf ./mongorestore/testdata/longcollectionname/
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_files_include_filter:
          - src/github.com/mongodb/mongo-tools/release.*
          - src/github.com/mongodb/mongo-tools/*.deb
          - src/github.com/mongodb/mongo-tools/*.rpm
        remote_file: mongo-tools/task/sign/${build_id}/
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream

  "upload release packages to s3":
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          ${_set_shell_env}
          go run release/release.go upload-release

  "upload release json feed to s3":
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          ${_set_shell_env}
          go run release/release.go upload-json
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/github.com/mongodb/mongo-tools/release.json
        remote_file: mongo-tools/release/${build_id}/
        optional: true
        content_type: application/json
        bucket: mciuploads
        permissions: public-read

  "upload release packages to linux repos":
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          curl -L -O http://boxes.10gen.com/build/curator/curator-dist-rhel70-latest.tar.gz
          tar -zxvf curator-dist-rhel70-latest.tar.gz
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          ${_set_shell_env}
          go run release/release.go linux-release

  "fetch source" :
    - command: shell.exec
      params:
        script: |
          set -x
          set -v
          set -e
          mkdir -p src/github.com/mongodb
    - command: git.get_project
      params:
        directory: src/github.com/mongodb/mongo-tools
    - command: git.apply_patch
      params:
        directory: src/github.com/mongodb/mongo-tools
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          mkdir -p bin

  "fetch ftdc" :
  - command: shell.exec
    type: test
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        GOPATH=$PWD go get github.com/10gen/ftdc-utils/cmd/ftdc

  "fetch golangci-lint" :
    - command: shell.exec
      type: test
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          curl -sfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s latest

  "create auth_user" :
  - command: shell.exec
    params:
      working_dir: src/github.com/mongodb/mongo-tools
      script: |
        set -x
        set -v
        set -e
        ./bin/mongo --port ${mongod_port} admin --eval "db.createUser({user:\"authorizedUser\", pwd: \"authorizedPwd\", roles:[\"readWriteAnyDatabase\", \"clusterManager\"]});"

  "create sharded_cluster" :
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        background: true
        script: |
          set -x
          set -v
          set -e
          echo "starting sharded cluster"
          mkdir -p /data/db/
          PATH=./bin:$PATH ./bin/mongo --nodb --eval 'var d = new ShardingTest({shards:3, mongos:[{port:${mongod_port}}]}); while(true){sleep(1000)}' 
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          ./bin/mongo --nodb --eval 'var d; assert.soon(function(x){try{d = new Mongo("localhost:${mongod_port}"); return true} catch(e){return false}}, "timed out connection");d.setLogLevel(5, "write");'

  "create repl_set" :
    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        background: true
        script: |
          set -x
          set -v
          set -e
          echo "starting repl set"
          MONGO_ARGS="${mongo_args}"
          NODE_OPTIONS=""
          mkdir -p /data/db/
          if [ "${USE_TLS}" = "true" ]; then
            NODE_OPTIONS="${replsettest_tls_config}"
            MONGO_ARGS="${mongo_args_tls}"
          elif [ "${USE_SSL}" = "true" ]; then
            NODE_OPTIONS="${replsettest_ssl_config}"
          fi

          PATH=./bin:$PATH ./bin/mongo $MONGO_ARGS --nodb --eval 'TestData = new Object(); TestData.minPort="${mongod_port}"; var repl = new ReplSetTest({nodes:1, name:"repltester", nodeOptions: {'"$NODE_OPTIONS"'}});repl.startSet();repl.initiate();repl.awaitSecondaryNodes();while(true){sleep(1000);}'

    - command: shell.exec
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          MONGO_ARGS="${mongo_args}"
          if [ "${USE_TLS}" = "true" ]; then
            MONGO_ARGS="${mongo_args_tls}"
          fi;
          ./bin/mongo $MONGO_ARGS --nodb --eval 'assert.soon(function(x){try{var d = new Mongo("localhost:${mongod_port}"); return true} catch(e){return false}}, "timed out connection")'

pre:
  - command: shell.exec
    params:
      silent: true
      script: |
        set -x
          set -v
        ${killall_mci|pkill -9 mongo; pkill -9 mongodump; pkill -9 mongoexport; pkill -9 mongoimport; pkill -9 mongofiles; pkill -9 mongorestore; pkill -9 mongostat; pkill -9 mongotop; pkill -9 mongod; pkill -9 mongos; pkill -f buildlogger.py; pkill -f smoke.py} >/dev/null 2>&1
        rm -rf src /data/db/*
        exit 0
  - command: shell.exec
    params:
      script: |
        cat <<EOT > expansions.yml
        _set_shell_env: |
          . ./set_goenv.sh
          GOROOT=""; set_goenv
          export EVG_IS_PATCH='${is_patch}'
          export EVG_BUILD_ID='${build_id}'
          export EVG_VARIANT='${build_variant}'
          export EVG_USER='${evg_user}'
          export EVG_KEY='${evg_key}'
          export AWS_ACCESS_KEY_ID='${release_aws_access_key_id}'
          export AWS_SECRET_ACCESS_KEY='${release_aws_secret}'
          export NOTARY_KEY_NAME='server-4.4'
          export NOTARY_TOKEN='${signing_auth_token_server_4_4}'
          export BARQUE_USERNAME='${evg_user}'
          export BARQUE_API_KEY='${barque_api_key}'
          set -o xtrace
          set -o verbose
          set -o errexit
        EOT
  - command: expansions.update
    params:
      file: expansions.yml

post:
    # attach.results works for jstests, gotest.parse_files for golang tests
  - command: attach.results
    params:
      file_location: src/github.com/mongodb/mongo-tools/report.json
  - command: gotest.parse_files
    params:
      files: ["src/github.com/mongodb/mongo-tools/testing_output/*.suite"]
  - command: shell.exec
    params:
      silent: true
      script: |
        set -x
        set -v
        ${killall_mci|pkill -9 mongo; pkill -9 mongodump; pkill -9 mongoexport; pkill -9 mongoimport; pkill -9 mongofiles; pkill -9 mongorestore; pkill -9 mongostat; pkill -9 mongotop; pkill -9 mongod; pkill -9 mongos; pkill -f buildlogger.py; pkill -f smoke.py} >/dev/null 2>&1
        exit 0
  - command: shell.exec
    params:
      script: |
        set -x
          set -v
        rm -rf /data/db/*
        exit 0

timeout:
  - command: shell.exec
    params:
      silent: true
      script: |
        set -x
          set -v
        # don't attempt to abort on any distro which has a special way of
        # killing everything (i.e. using taskkill on Windows)
        if [ "${killall_mci}" = "" ]; then
          all_tools="bsondump mongodump mongoexport mongofiles mongoimport mongorestore mongostat mongotop"
          # send SIGABRT to print a stacktrace for any hung tool
          pkill -ABRT "^($(echo -n $all_tools | tr ' ' '|'))\$"
          # git the processes a second or two to dump their stacks
          sleep 10
        fi


tasks:
- name: dist
  depends_on:
  commands:
    - func: "fetch source"
    # bsondump
    - func: "build tool"
      vars:
        tool: bsondump
    - func: "upload tool"
      vars:
        tool: bsondump
    # mongodump
    - func: "build tool"
      vars:
        tool: mongodump
    - func: "upload tool"
      vars:
        tool: mongodump
    # mongoexport
    - func: "build tool"
      vars:
        tool: mongoexport
    - func: "upload tool"
      vars:
        tool: mongoexport
    # mongofiles
    - func: "build tool"
      vars:
        tool: mongofiles
    - func: "upload tool"
      vars:
        tool: mongofiles
    # mongoimport
    - func: "build tool"
      vars:
        tool: mongoimport
    - func: "upload tool"
      vars:
        tool: mongoimport
    # mongorestore
    - func: "build tool"
      vars:
        tool: mongorestore
    - func: "upload tool"
      vars:
        tool: mongorestore
    # mongostat
    - func: "build tool"
      vars:
        tool: mongostat
    - func: "upload tool"
      vars:
        tool: mongostat
    # mongotop
    - func: "build tool"
      vars:
        tool: mongotop
    - func: "upload tool"
      vars:
        tool: mongotop
    - func: "create release artifacts"

# Regardless of the buildvariant, the sign task must be run on a
# distro that has the notary client available. We will use
# amazon1-2018-test for this purpose. The notary client is not
# available on all distros, which is why sign must be a separate task.
- name: sign
  depends_on:
    - name: dist
  commands:
    - func: "fetch dist release artifacts"
    - func: "sign msi installer"
    - func: "sign macos zip"
    - func: "sign linux packages"
    - func: "sign archives"
    - func: "upload signed release artifacts"

- name: push
  depends_on:
    - name: sign
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "upload release packages to s3"
    - func: "upload release packages to linux repos"

- name: release-json
  depends_on:
    - name: push
      variant: '*'
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "upload release json feed to s3"

- name: integration-3.4
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "3.4"
    - func: "start mongod"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-3.4-mmapv1
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "3.4"
    - func: "start mongod"
      vars:
        STORAGE_ENGINE: "mmapv1"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-3.6
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "3.6"
    - func: "start mongod"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-3.6-mmapv1
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "3.6"
    - func: "start mongod"
      vars:
        STORAGE_ENGINE: "mmapv1"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-4.0
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "4.0"
    - func: "start mongod"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
          INT_TEST: "true"
          USE_SSL: "true"

- name: integration-4.0-auth
  commands:
    - func: "fetch source"
    # Concat auth args
    - command: expansions.update
      params:
        updates:
          - key: "mongod_args"
            concat: " --auth"
          - key: "create_mongod_users_command"
            value: "db.createUser({ user: '${auth_username}', pwd: '${auth_password}', roles: [{ role: '__system', db: 'admin' }] });"
    - func: "download mongod"
      vars:
        mongo_version: "4.0"
    - func: "start mongod"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
          INT_TEST: "true"
          AUTH_TEST: "true"
          USE_SSL: "true"

- name: integration-4.0-cluster
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "4.0"
    - func: "create repl_set"
      vars:
        USE_SSL: "true"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-4.0-mmapv1
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "4.0"
    - func: "start mongod"
      vars:
        STORAGE_ENGINE: "mmapv1"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-4.2
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "4.2"
    - func: "start mongod"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-4.2-auth
  commands:
    - func: "fetch source"
    # Concat auth args
    - command: expansions.update
      params:
        updates:
          - key: "mongod_args"
            concat: " --auth"
          - key: "create_mongod_users_command"
            value: "db.createUser({ user: '${auth_username}', pwd: '${auth_password}', roles: [{ role: '__system', db: 'admin' }] });"
    - func: "download mongod"
      vars:
        mongo_version: "4.2"
    - func: "start mongod"
    - func: "wait for mongod to be ready"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        AUTH_TEST: "true"
        USE_SSL: "true"

- name: integration-4.4
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "4.4"
    - func: "start mongod"
      vars:
        USE_TLS: "true"
    - func: "wait for mongod to be ready"
      vars:
        USE_TLS: "true"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: integration-4.4-auth
  commands:
    - func: "fetch source"
    # Concat auth args
    - command: expansions.update
      params:
        updates:
          - key: "mongod_args_tls"
            concat: " --auth"
          - key: "create_mongod_users_command"
            value: "db.createUser({ user: '${auth_username}', pwd: '${auth_password}', roles: [{ role: '__system', db: 'admin' }] });"
    - func: "download mongod"
      vars:
        mongo_version: "4.4"
    - func: "start mongod"
      vars:
        USE_TLS: "true"
    - func: "wait for mongod to be ready"
      vars:
        USE_TLS: "true"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        AUTH_TEST: "true"
        USE_SSL: "true"

- name: integration-4.4-cluster
  commands:
    - func: "fetch source"
    - command: expansions.update
    - func: "download mongod"
      vars:
        mongo_version: "4.4"
    - func: "create repl_set"
      vars:
        USE_TLS: "true"
    - func: "run tool integration tests"
      vars:
        INT_TEST: "true"
        USE_SSL: "true"

- name: kerberos
  commands:
    - func: "fetch source"
    # Explicitly run ONLY Kerberos tests
    - command: expansions.update
      params:
        updates:
          - key: "args"
            value: "${args} -test.types=kerberos"
    - func: "setup integration test"
    - func: "run tool integration tests"
      vars:
          KERBEROS_TEST: "true"

- name: legacy42
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "4.2"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - func: "run legacy tests"
      vars:
        test_path: "test/legacy42"

- name: format-go
  commands:
    - func: "fetch source"
    - func: "fetch golangci-lint"
    - command: shell.exec
      type: test
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          . ./set_goenv.sh
          GOROOT=""; set_goenv || exit
          PATH=$PATH:$PWD/bin golangci-lint run --disable-all -E gofmt ./...
          exit $?

- name: lint-go
  commands:
    - func: "fetch source"
    - command: shell.exec
      type: test
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          . ./set_goenv.sh
          GOROOT=""; set_goenv || exit
          retVal=$(go run vendor/github.com/3rf/mongo-lint/golint/golint.go mongo* bson*);
          if [ "$retVal" = "" ]; then exit 0; else echo $retVal; exit 1; fi;

- name: lint-js
  commands:
    - func: "fetch source"
    - command: shell.exec
      type: test
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          PATH="/opt/node/bin:$PATH"
          /opt/node/bin/npm install eslint@3.2
          /opt/node/bin/node node_modules/eslint/bin/eslint.js test/qa-tests/jstests/**/*.js


- name: qa-tests-4.4
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "4.4"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongotop
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - func: "run qa-tests"
      vars:
        resmoke_suite: "core${resmoke_use_tls}"
        excludes: "requires_unstable,${excludes}"

- name: qa-tests-4.2
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "4.2"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongotop
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - func: "run qa-tests"
      vars:
        resmoke_suite: "core${resmoke_use_tls}"
        excludes: "requires_unstable,${excludes}"

- name: qa-tests-4.0
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "4.0"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongotop
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - func: "run qa-tests"
      vars:
        resmoke_suite: "core${resmoke_use_ssl}"
        excludes: "requires_min_mongo_42,requires_unstable,${excludes}"

- name: qa-tests-3.6
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "3.6"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongotop
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - func: "run qa-tests"
      vars:
        resmoke_suite: "core${resmoke_use_ssl}"
        excludes: "requires_min_mongo_40,requires_min_mongo_42,requires_unstable,${excludes}"

- name: qa-tests-3.4
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "3.4"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongotop
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - func: "run qa-tests"
      vars:
        resmoke_suite: "core${resmoke_use_ssl}"
        excludes: "requires_min_mongo_36,requires_min_mongo_40,requires_min_mongo_42,requires_unstable,${excludes}"

- name: qa-tests-3.2
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "3.2"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongotop
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - func: "run qa-tests"
      vars:
        resmoke_suite: "core${resmoke_use_ssl}"
        excludes: "requires_min_mongo_34,requires_min_mongo_36,requires_min_mongo_40,requires_min_mongo_42,requires_unstable,${excludes}"

- name: native-cert-ssl-current
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "4.4"
    - func: "fetch tool"
      vars:
        tool: mongoimport
    - func: "fetch tool"
      vars:
        tool: mongoexport
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "fetch tool"
      vars:
        tool: mongostat
    - func: "fetch tool"
      vars:
        tool: mongotop
    - func: "fetch tool"
      vars:
        tool: mongofiles
    - func: "fetch tool"
      vars:
        tool: bsondump
    - command: shell.exec
      type: test
      params:
        working_dir: src/github.com/mongodb/mongo-tools/test/qa-tests
        script: |
          set -x
          set -v
          set -e
          chmod +x ../../bin/*
          mv ../../bin/* .
          chmod 400 jstests/libs/key*
          python buildscripts/resmoke.py --suite=native_cert_ssl  --continueOnFailure --log=buildlogger --reportFile=../../report.json ${resmoke_args} --excludeWithAnyTags="${excludes}"

- name: qa-dump-restore-with-archiving-current
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "4.4"
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "run qa-tests"
      vars:
        resmoke_suite: "restore_archive"
        excludes: "requires_unstable,${excludes}"

- name: qa-dump-restore-with-gzip-current
  depends_on:
  - name: dist
  commands:
    - func: "fetch source"
    - func: "get buildnumber"
    - func: "setup credentials"
    - func: "download mongod"
      vars:
        mongo_version: "4.4"
    - func: "fetch tool"
      vars:
        tool: mongodump
    - func: "fetch tool"
      vars:
        tool: mongorestore
    - func: "run qa-tests"
      vars:
        resmoke_suite: "restore_gzip"
        excludes: "requires_unstable,${excludes}"

- name: unit
  commands:
    - command: expansions.update
    - func: "fetch source"
    - func: "run tool unit tests"
      vars:
          UNIT_TEST: "true"
          run_coverage: "true"
    - func: "create coverage reports"
    - command: expansions.update
      params:
        updates:
          - key: "coverage_pkg"
            value: "mongoimport"
    - func: "upload html coverage"
    - func: "upload text coverage"
    - command: expansions.update
      params:
        updates:
          - key: "coverage_pkg"
            value: "mongoexport"
    - func: "upload html coverage"
    - func: "upload text coverage"
    - command: expansions.update
      params:
        updates:
          - key: "coverage_pkg"
            value: "mongostat"
    - func: "upload html coverage"
    - func: "upload text coverage"
    - command: expansions.update
      params:
        updates:
          - key: "coverage_pkg"
            value: "mongodump"
    - func: "upload html coverage"
    - func: "upload text coverage"
    - command: expansions.update
      params:
        updates:
          - key: "coverage_pkg"
            value: "mongorestore"
    - func: "upload html coverage"
    - func: "upload text coverage"

- name: vet
  commands:
    - func: "fetch source"
    - command: shell.exec
      type: test
      params:
        working_dir: src/github.com/mongodb/mongo-tools
        script: |
          set -x
          set -v
          set -e
          go tool vet bsondump mongo*

buildvariants:

#######################################
#     Static Analysis Buildvariant    #
#######################################

- name: static
  display_name: '! Static Analysis'
  run_on:
  - rhel62-small
  expansions:
    build_tags: "failpoints ssl sasl gssapi"
    _platform: rhel62
  tasks:
  - name: format-go
  - name: lint-go
  - name: lint-js
  - name: vet

#######################################
#     Release Manager Buildvariant    #
#######################################

- name: release
  display_name: 'Release Manager'
  run_on:
  - amazon1-2018-test
  tasks:
  - name: release-json

#######################################
#     Amazon x86_64 Buildvariants     #
#######################################

- name: amazon
  display_name: Amazon Linux 64
  run_on:
  - amazon1-2018-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: amazon2
  display_name: Amazon Linux 64 v2
  run_on:
  - amazon2-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

#######################################
#     Debian x86_64 Buildvariants     #
#######################################

- name: debian81
  display_name: Debian 8.1
  run_on:
  - debian81-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: debian92
  display_name: Debian 9.2
  run_on:
  - debian92-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: debian10
  display_name: Debian 10
  run_on:
    - debian10-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

#######################################
#           macOS Buildvariant        #
#######################################

- name: macos
  display_name: MacOS 10.14
  run_on:
  - macos-1014
  expansions:
    <<: *mongod_ssl_startup_args
    <<: *mongo_ssl_startup_args
    <<: *mongod_tls_startup_args
    <<: *mongo_tls_startup_args
    mongo_os: "osx"
    mongo_target: "osx-ssl"
    excludes: requires_many_files
    build_tags: "failpoints ssl sasl gssapi"
    smoke_use_ssl: --use-ssl
    resmoke_use_ssl: _ssl
    USE_SSL: "true"
  tasks: *macos_tasks

#######################################
#     RHEL x86_64 Buildvariants       #
#######################################

- name: rhel62
  display_name: RHEL 6.2
  run_on:
  - rhel62-small
  expansions:
    <<: *mongod_ssl_startup_args
    <<: *mongo_ssl_startup_args
    <<: *mongod_tls_startup_args
    <<: *mongo_tls_startup_args
    mongo_os: "rhel62"
    mongo_edition: "enterprise"
    build_tags: "failpoints ssl tls sasl gssapi"
    smoke_use_ssl: --use-ssl
    resmoke_use_ssl: _ssl
    smoke_use_tls: --use-tls
    resmoke_use_tls: _tls
    edition: enterprise
    run_kinit: true
    resmoke_args: --jobs $(grep -c ^processor /proc/cpuinfo)
  tasks: *rhel_x86_64_tasks

- name: rhel70
  display_name: RHEL 7.0
  run_on:
  - rhel70-small
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: rhel80
  display_name: RHEL 8.0
  run_on:
  - rhel80-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

#######################################
#     SUSE x86_64 Buildvariants       #
#######################################

- name: suse12
  display_name: SUSE 12
  run_on:
  - suse12-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: suse15
  display_name: SUSE 15
  run_on:
    - suse15-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

#######################################
#    Ubuntu x86_64 Buildvariants      #
#######################################

- name: ubuntu1404
  display_name: Ubuntu 14.04
  run_on:
  - ubuntu1404-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: ubuntu1604
  display_name: Ubuntu 16.04
  run_on:
  - ubuntu1604-test
  expansions:
    <<: *mongod_ssl_startup_args
    <<: *mongo_ssl_startup_args
    <<: *mongod_tls_startup_args
    <<: *mongo_tls_startup_args
    mongo_os: "ubuntu1604"
    mongo_edition: "enterprise"
    build_tags: "failpoints ssl tls sasl gssapi"
    smoke_use_ssl: --use-ssl
    resmoke_use_ssl: _ssl
    smoke_use_tls: --use-tls
    resmoke_use_tls: _tls
    edition: enterprise
    run_kinit: true
    resmoke_args: --jobs $(grep -c ^processor /proc/cpuinfo)
  tasks: *ubuntu_x86_64_tasks

- name: ubuntu1804
  display_name: Ubuntu 18.04
  run_on:
  - ubuntu1804-test
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: ubuntu2004
  display_name: Ubuntu 20.04
  run_on:
  - ubuntu2004-small
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

#######################################
#        Windows Buildvariants        #
#######################################

- name: windows
  display_name: Windows 64-bit
  run_on:
  - windows-64-vs2017-compile
  expansions:
    <<: *mongod_ssl_startup_args
    <<: *mongo_ssl_startup_args
    <<: *mongod_tls_startup_args
    <<: *mongo_tls_startup_args
    mongo_os: "windows-64"
    mongo_edition: "enterprise"
    mongo_target: "windows"
    build_tags: "failpoints sasl gssapi ssl"
    smoke_use_ssl: --use-ssl
    resmoke_args: --jobs $(grep -c ^processor /proc/cpuinfo)
    resmoke_use_ssl: _ssl
    excludes: requires_large_ram,requires_mongo_24
    edition: enterprise
    extension: .exe
    preproc_gpm: "perl -pi -e 's/\\r\\n/\\n/g' "
    USE_SSL: "true"
  tasks: *windows_64_tasks

#######################################
#        ARM Buildvariants            #
#######################################

# MongoDB 3.4 - 4.0
- name: ubuntu1604-arm64
  display_name: ZAP ARM64 Ubuntu 16.04
  run_on:
  - ubuntu1604-arm64-small
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    <<: *mongod_ssl_startup_args
    <<: *mongo_ssl_startup_args
    <<: *mongod_tls_startup_args
    <<: *mongo_tls_startup_args
    mongo_os: "ubuntu1604"
    mongo_edition: "targeted"
    mongo_arch: "arm64"
    build_tags: "failpoints ssl"
    resmoke_use_ssl: _ssl
    excludes: requires_mmap_available,requires_large_ram,requires_mongo_24,requires_mongo_26,requires_mongo_30
    resmoke_args: -j 2
    edition: ssl
    USE_SSL: "true"
  tasks: *ubuntu1604_arm64_tasks

# MongoDB 4.2+
- name: ubuntu1804-arm64
  display_name: ZAP ARM64 Ubuntu 18.04
  run_on:
  - ubuntu1804-arm64-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    <<: *mongod_ssl_startup_args
    <<: *mongo_ssl_startup_args
    <<: *mongod_tls_startup_args
    <<: *mongo_tls_startup_args
    mongo_os: "ubuntu1804"
    mongo_edition: "targeted"
    mongo_arch: "aarch64"
    build_tags: "failpoints ssl"
    resmoke_use_tls: _tls
    excludes: requires_mmap_available,requires_large_ram,requires_mongo_24,requires_mongo_26,requires_mongo_30
    resmoke_args: -j 2
    edition: ssl
    USE_SSL: "true"
  tasks: *ubuntu1804_arm64_tasks

# MongoDB 4.4+
- name: ubuntu2004-arm64
  display_name: ZAP ARM64 Ubuntu 20.04
  run_on:
    - ubuntu2004-arm64-small
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    <<: *mongod_ssl_startup_args
    <<: *mongo_ssl_startup_args
    <<: *mongod_tls_startup_args
    <<: *mongo_tls_startup_args
    mongo_os: "ubuntu2004"
    mongo_edition: "targeted"
    mongo_arch: "aarch64"
    build_tags: "failpoints ssl"
    resmoke_use_tls: _tls
    excludes: requires_mmap_available,requires_large_ram,requires_mongo_24,requires_mongo_26,requires_mongo_30
    resmoke_args: -j 2
    edition: ssl
    USE_SSL: "true"
  tasks: *ubuntu2004_arm64_tasks

#######################################
#        Power Buildvariants          #
#######################################

- name: rhel71-ppc64le
  display_name: ZAP PPC64LE RHEL 7.1
  run_on:
  - rhel71-power8-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    <<: *mongod_default_startup_args
    <<: *mongo_default_startup_args
    mongo_os: "rhel71"
    mongo_edition: "enterprise"
    mongo_arch: "ppc64le"
    build_tags: 'failpoints ssl sasl gssapi'
    resmoke_use_ssl: _ssl
    resmoke_args: -j 4
    excludes: requires_mmap_available,requires_large_ram,requires_mongo_24,requires_mongo_26,requires_mongo_30
    edition: enterprise
    run_kinit: true
  tasks: *rhel71_ppc64le_tasks

- name: rhel81-ppc64le
  display_name: ZAP PPC64LE RHEL 8.1
  run_on:
  - rhel81-power8-small
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    <<: *mongod_default_startup_args
    <<: *mongo_default_startup_args
    mongo_os: "rhel81"
    mongo_edition: "enterprise"
    mongo_arch: "ppc64le"
    build_tags: 'failpoints ssl sasl gssapi'
    resmoke_use_ssl: _ssl
    resmoke_args: -j 4
    excludes: requires_mmap_available,requires_large_ram,requires_mongo_24,requires_mongo_26,requires_mongo_30
    edition: enterprise
    run_kinit: true
  tasks: *rhel81_ppc64le_tasks

# MongoDB 3.4 - 4.0
- name: ubuntu1604-ppc64le
  display_name: ZAP PPC64LE Ubuntu 16.04
  run_on:
  - ubuntu1604-power8-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    build_tags: 'failpoints ssl sasl gssapi'
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

# MongoDB 4.2+
- name: ubuntu1804-ppc64le
  display_name: ZAP PPC64LE Ubuntu 18.04
  run_on:
  - ubuntu1804-power8-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    build_tags: 'failpoints ssl sasl gssapi'
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

#######################################
#     Z (s390x) Buildvariants         #
#######################################

- name: rhel67-s390x
  display_name: ZAP s390x RHEL 6.7
  run_on:
  - rhel67-zseries-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    <<: *mongod_default_startup_args
    <<: *mongo_default_startup_args
    mongo_os: "rhel67"
    mongo_edition: "enterprise"
    mongo_arch: "s390x"
    build_tags: "failpoints sasl gssapi ssl"
    resmoke_use_ssl: _ssl
    excludes: requires_mmap_available,requires_mongo_24,requires_mongo_26,requires_mongo_30
    resmoke_args: -j 2
    edition: enterprise
    run_kinit: true
  tasks: *rhel67_s390x_tasks

- name: rhel72-s390x
  display_name: ZAP s390x RHEL 7.2
  run_on:
  - rhel72-zseries-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: suse12-s390x
  display_name: ZAP s390x SUSE 12
  run_on:
    - suse12-zseries-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: ubuntu1604-s390x
  display_name: ZAP s390x Ubuntu 16.04
  run_on:
  - ubuntu1604-zseries-small
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

- name: ubuntu1804-s390x
  display_name: ZAP s390x Ubuntu 18.04
  run_on:
  - ubuntu1804-zseries-test
  stepback: false
  batchtime: 10080 # weekly
  expansions:
    build_tags: "failpoints sasl gssapi ssl"
  tasks:
  - name: dist
  - name: sign
    run_on: amazon1-2018-test
  - name: push
    run_on: rhel70-small

#######################################
#     Experimental Buildvariants      #
#######################################

- name: ubuntu-race
  stepback: false
  batchtime: 1440 # daily
  display_name: z Race Detector Ubuntu 16.04
  run_on:
  - ubuntu1604-test
  expansions:
    <<: *mongod_default_startup_args
    <<: *mongo_default_startup_args
    mongo_os: "ubuntu1604"
    mongo_edition: "enterprise"
    build_tags: "failpoints sasl gssapi ssl"
    args: "-buildmode=default -race"
    excludes: requires_large_ram
  tasks: *ubuntu_x86_64_race_tasks
